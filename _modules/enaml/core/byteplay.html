


<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>enaml.core.byteplay &mdash; enaml 0.2beta-1 documentation</title>
    
    <link rel="stylesheet" href="../../../_static/enthought_doc.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../../',
        VERSION:     '0.2beta-1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../_static/doctools.js"></script>
    <link rel="shortcut icon" href="../../../_static/et.ico"/>
    <link rel="top" title="enaml 0.2beta-1 documentation" href="../../../index.html" />
    <link rel="up" title="Module code" href="../../index.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../../enaml-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../../../index.html">enaml 0.2beta-1 documentation</a> &raquo;</li>
          <li><a href="../../index.html" accesskey="U">Module code</a> &raquo;</li>
  
    <li><a href="#">enaml.core.byteplay</a></li>
  

      </ul>
    </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../../../index.html">
              <img class="logo" src="../../../_static/e-logo-rev.png" alt="Logo"/>
            </a></p>
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <h1>Source code for enaml.core.byteplay</h1><div class="highlight"><pre>
<span class="c"># byteplay - Python bytecode assembler/disassembler.</span>
<span class="c"># Copyright (C) 2006-2010 Noam Yorav-Raphael</span>
<span class="c"># Homepage: http://code.google.com/p/byteplay</span>
<span class="c">#</span>
<span class="c"># This library is free software; you can redistribute it and/or</span>
<span class="c"># modify it under the terms of the GNU Lesser General Public</span>
<span class="c"># License as published by the Free Software Foundation; either</span>
<span class="c"># version 2.1 of the License, or (at your option) any later version.</span>
<span class="c">#</span>
<span class="c"># This library is distributed in the hope that it will be useful,</span>
<span class="c"># but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="c"># MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU</span>
<span class="c"># Lesser General Public License for more details.</span>
<span class="c">#</span>
<span class="c"># You should have received a copy of the GNU Lesser General Public</span>
<span class="c"># License along with this library; if not, write to the Free Software</span>
<span class="c"># Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA  02110-1301  USA</span>

<span class="c"># Many thanks to Greg X for adding support for Python 2.6 and 2.7!</span>

<span class="n">__version__</span> <span class="o">=</span> <span class="s">&#39;0.2&#39;</span>

<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;opmap&#39;</span><span class="p">,</span> <span class="s">&#39;opname&#39;</span><span class="p">,</span> <span class="s">&#39;opcodes&#39;</span><span class="p">,</span>
           <span class="s">&#39;cmp_op&#39;</span><span class="p">,</span> <span class="s">&#39;hasarg&#39;</span><span class="p">,</span> <span class="s">&#39;hasname&#39;</span><span class="p">,</span> <span class="s">&#39;hasjrel&#39;</span><span class="p">,</span> <span class="s">&#39;hasjabs&#39;</span><span class="p">,</span>
           <span class="s">&#39;hasjump&#39;</span><span class="p">,</span> <span class="s">&#39;haslocal&#39;</span><span class="p">,</span> <span class="s">&#39;hascompare&#39;</span><span class="p">,</span> <span class="s">&#39;hasfree&#39;</span><span class="p">,</span> <span class="s">&#39;hascode&#39;</span><span class="p">,</span>
           <span class="s">&#39;hasflow&#39;</span><span class="p">,</span> <span class="s">&#39;getse&#39;</span><span class="p">,</span>
           <span class="s">&#39;Opcode&#39;</span><span class="p">,</span> <span class="s">&#39;SetLineno&#39;</span><span class="p">,</span> <span class="s">&#39;Label&#39;</span><span class="p">,</span> <span class="s">&#39;isopcode&#39;</span><span class="p">,</span> <span class="s">&#39;Code&#39;</span><span class="p">,</span>
           <span class="s">&#39;CodeList&#39;</span><span class="p">,</span> <span class="s">&#39;printcodelist&#39;</span><span class="p">]</span>

<span class="kn">import</span> <span class="nn">opcode</span>
<span class="kn">from</span> <span class="nn">dis</span> <span class="kn">import</span> <span class="n">findlabels</span>
<span class="kn">import</span> <span class="nn">types</span>
<span class="kn">from</span> <span class="nn">array</span> <span class="kn">import</span> <span class="n">array</span>
<span class="kn">import</span> <span class="nn">operator</span>
<span class="kn">import</span> <span class="nn">itertools</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">from</span> <span class="nn">cStringIO</span> <span class="kn">import</span> <span class="n">StringIO</span>

<span class="c">######################################################################</span>
<span class="c"># Define opcodes and information about them</span>

<span class="n">python_version</span> <span class="o">=</span> <span class="s">&#39;.&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">sys</span><span class="o">.</span><span class="n">version_info</span><span class="p">[:</span><span class="mi">2</span><span class="p">])</span>
<span class="k">if</span> <span class="n">python_version</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39;2.4&#39;</span><span class="p">,</span> <span class="s">&#39;2.5&#39;</span><span class="p">,</span> <span class="s">&#39;2.6&#39;</span><span class="p">,</span> <span class="s">&#39;2.7&#39;</span><span class="p">):</span>
    <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s">&quot;byteplay doesn&#39;t support Python version &quot;</span><span class="o">+</span><span class="n">python_version</span><span class="p">)</span>

<div class="viewcode-block" id="Opcode"><a class="viewcode-back" href="../../../api_ref/enaml.core.html#enaml.core.byteplay.Opcode">[docs]</a><span class="k">class</span> <span class="nc">Opcode</span><span class="p">(</span><span class="nb">int</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;An int which represents an opcode - has a nicer repr.&quot;&quot;&quot;</span>
<div class="viewcode-block" id="Opcode.__repr__"><a class="viewcode-back" href="../../../api_ref/enaml.core.html#enaml.core.byteplay.Opcode.__repr__">[docs]</a>    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">opname</span><span class="p">[</span><span class="bp">self</span><span class="p">]</span></div>
    <span class="n">__str__</span> <span class="o">=</span> <span class="n">__repr__</span>
</div>
<div class="viewcode-block" id="CodeList"><a class="viewcode-back" href="../../../api_ref/enaml.core.html#enaml.core.byteplay.CodeList">[docs]</a><span class="k">class</span> <span class="nc">CodeList</span><span class="p">(</span><span class="nb">list</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A list for storing opcode tuples - has a nicer __str__.&quot;&quot;&quot;</span>
<div class="viewcode-block" id="CodeList.__str__"><a class="viewcode-back" href="../../../api_ref/enaml.core.html#enaml.core.byteplay.CodeList.__str__">[docs]</a>    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">f</span> <span class="o">=</span> <span class="n">StringIO</span><span class="p">()</span>
        <span class="n">printcodelist</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">f</span><span class="o">.</span><span class="n">getvalue</span><span class="p">()</span>
</div></div>
<span class="n">opmap</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">((</span><span class="n">name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;+&#39;</span><span class="p">,</span> <span class="s">&#39;_&#39;</span><span class="p">),</span> <span class="n">Opcode</span><span class="p">(</span><span class="n">code</span><span class="p">))</span>
             <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">code</span> <span class="ow">in</span> <span class="n">opcode</span><span class="o">.</span><span class="n">opmap</span><span class="o">.</span><span class="n">iteritems</span><span class="p">()</span>
             <span class="k">if</span> <span class="n">name</span> <span class="o">!=</span> <span class="s">&#39;EXTENDED_ARG&#39;</span><span class="p">)</span>
<span class="n">opname</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">((</span><span class="n">code</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span> <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">code</span> <span class="ow">in</span> <span class="n">opmap</span><span class="o">.</span><span class="n">iteritems</span><span class="p">())</span>
<span class="n">opcodes</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">opname</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">globalize_opcodes</span><span class="p">():</span>
    <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">code</span> <span class="ow">in</span> <span class="n">opmap</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
        <span class="nb">globals</span><span class="p">()[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">code</span>
        <span class="n">__all__</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
<span class="n">globalize_opcodes</span><span class="p">()</span>

<span class="n">cmp_op</span> <span class="o">=</span> <span class="n">opcode</span><span class="o">.</span><span class="n">cmp_op</span>

<span class="n">hasarg</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">opcodes</span> <span class="k">if</span> <span class="n">x</span> <span class="o">&gt;=</span> <span class="n">opcode</span><span class="o">.</span><span class="n">HAVE_ARGUMENT</span><span class="p">)</span>
<span class="n">hasconst</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">Opcode</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">opcode</span><span class="o">.</span><span class="n">hasconst</span><span class="p">)</span>
<span class="n">hasname</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">Opcode</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">opcode</span><span class="o">.</span><span class="n">hasname</span><span class="p">)</span>
<span class="n">hasjrel</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">Opcode</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">opcode</span><span class="o">.</span><span class="n">hasjrel</span><span class="p">)</span>
<span class="n">hasjabs</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">Opcode</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">opcode</span><span class="o">.</span><span class="n">hasjabs</span><span class="p">)</span>
<span class="n">hasjump</span> <span class="o">=</span> <span class="n">hasjrel</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="n">hasjabs</span><span class="p">)</span>
<span class="n">haslocal</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">Opcode</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">opcode</span><span class="o">.</span><span class="n">haslocal</span><span class="p">)</span>
<span class="n">hascompare</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">Opcode</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">opcode</span><span class="o">.</span><span class="n">hascompare</span><span class="p">)</span>
<span class="n">hasfree</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">Opcode</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">opcode</span><span class="o">.</span><span class="n">hasfree</span><span class="p">)</span>
<span class="n">hascode</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([</span><span class="n">MAKE_FUNCTION</span><span class="p">,</span> <span class="n">MAKE_CLOSURE</span><span class="p">])</span>

<span class="k">class</span> <span class="nc">_se</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Quick way of defining static stack effects of opcodes&quot;&quot;&quot;</span>
    <span class="c"># Taken from assembler.py by Phillip J. Eby</span>
    <span class="n">NOP</span>       <span class="o">=</span> <span class="mi">0</span><span class="p">,</span><span class="mi">0</span>

    <span class="n">POP_TOP</span>   <span class="o">=</span> <span class="mi">1</span><span class="p">,</span><span class="mi">0</span>
    <span class="n">ROT_TWO</span>   <span class="o">=</span> <span class="mi">2</span><span class="p">,</span><span class="mi">2</span>
    <span class="n">ROT_THREE</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span><span class="mi">3</span>
    <span class="n">ROT_FOUR</span>  <span class="o">=</span> <span class="mi">4</span><span class="p">,</span><span class="mi">4</span>
    <span class="n">DUP_TOP</span>   <span class="o">=</span> <span class="mi">1</span><span class="p">,</span><span class="mi">2</span>

    <span class="n">UNARY_POSITIVE</span> <span class="o">=</span> <span class="n">UNARY_NEGATIVE</span> <span class="o">=</span> <span class="n">UNARY_NOT</span> <span class="o">=</span> <span class="n">UNARY_CONVERT</span> <span class="o">=</span> \
        <span class="n">UNARY_INVERT</span> <span class="o">=</span> <span class="n">GET_ITER</span> <span class="o">=</span> <span class="n">LOAD_ATTR</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span><span class="mi">1</span>

    <span class="n">IMPORT_FROM</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span><span class="mi">2</span>

    <span class="n">BINARY_POWER</span> <span class="o">=</span> <span class="n">BINARY_MULTIPLY</span> <span class="o">=</span> <span class="n">BINARY_DIVIDE</span> <span class="o">=</span> <span class="n">BINARY_FLOOR_DIVIDE</span> <span class="o">=</span> \
        <span class="n">BINARY_TRUE_DIVIDE</span> <span class="o">=</span> <span class="n">BINARY_MODULO</span> <span class="o">=</span> <span class="n">BINARY_ADD</span> <span class="o">=</span> <span class="n">BINARY_SUBTRACT</span> <span class="o">=</span> \
        <span class="n">BINARY_SUBSCR</span> <span class="o">=</span> <span class="n">BINARY_LSHIFT</span> <span class="o">=</span> <span class="n">BINARY_RSHIFT</span> <span class="o">=</span> <span class="n">BINARY_AND</span> <span class="o">=</span> \
        <span class="n">BINARY_XOR</span> <span class="o">=</span> <span class="n">BINARY_OR</span> <span class="o">=</span> <span class="n">COMPARE_OP</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span><span class="mi">1</span>

    <span class="n">INPLACE_POWER</span> <span class="o">=</span> <span class="n">INPLACE_MULTIPLY</span> <span class="o">=</span> <span class="n">INPLACE_DIVIDE</span> <span class="o">=</span> \
        <span class="n">INPLACE_FLOOR_DIVIDE</span> <span class="o">=</span> <span class="n">INPLACE_TRUE_DIVIDE</span> <span class="o">=</span> <span class="n">INPLACE_MODULO</span> <span class="o">=</span> \
        <span class="n">INPLACE_ADD</span> <span class="o">=</span> <span class="n">INPLACE_SUBTRACT</span> <span class="o">=</span> <span class="n">INPLACE_LSHIFT</span> <span class="o">=</span> <span class="n">INPLACE_RSHIFT</span> <span class="o">=</span> \
        <span class="n">INPLACE_AND</span> <span class="o">=</span> <span class="n">INPLACE_XOR</span> <span class="o">=</span> <span class="n">INPLACE_OR</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span><span class="mi">1</span>

    <span class="n">SLICE_0</span><span class="p">,</span> <span class="n">SLICE_1</span><span class="p">,</span> <span class="n">SLICE_2</span><span class="p">,</span> <span class="n">SLICE_3</span> <span class="o">=</span> \
        <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">),(</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">),(</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">),(</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">STORE_SLICE_0</span><span class="p">,</span> <span class="n">STORE_SLICE_1</span><span class="p">,</span> <span class="n">STORE_SLICE_2</span><span class="p">,</span> <span class="n">STORE_SLICE_3</span> <span class="o">=</span> \
        <span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">),(</span><span class="mi">3</span><span class="p">,</span><span class="mi">0</span><span class="p">),(</span><span class="mi">3</span><span class="p">,</span><span class="mi">0</span><span class="p">),(</span><span class="mi">4</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">DELETE_SLICE_0</span><span class="p">,</span> <span class="n">DELETE_SLICE_1</span><span class="p">,</span> <span class="n">DELETE_SLICE_2</span><span class="p">,</span> <span class="n">DELETE_SLICE_3</span> <span class="o">=</span> \
        <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">),(</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">),(</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">),(</span><span class="mi">3</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>

    <span class="n">STORE_SUBSCR</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span><span class="mi">0</span>
    <span class="n">DELETE_SUBSCR</span> <span class="o">=</span> <span class="n">STORE_ATTR</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span><span class="mi">0</span>
    <span class="n">DELETE_ATTR</span> <span class="o">=</span> <span class="n">STORE_DEREF</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span><span class="mi">0</span>
    <span class="n">PRINT_NEWLINE</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span><span class="mi">0</span>
    <span class="n">PRINT_EXPR</span> <span class="o">=</span> <span class="n">PRINT_ITEM</span> <span class="o">=</span> <span class="n">PRINT_NEWLINE_TO</span> <span class="o">=</span> <span class="n">IMPORT_STAR</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span><span class="mi">0</span>
    <span class="n">STORE_NAME</span> <span class="o">=</span> <span class="n">STORE_GLOBAL</span> <span class="o">=</span> <span class="n">STORE_FAST</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span><span class="mi">0</span>
    <span class="n">PRINT_ITEM_TO</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span><span class="mi">0</span>

    <span class="n">LOAD_LOCALS</span> <span class="o">=</span> <span class="n">LOAD_CONST</span> <span class="o">=</span> <span class="n">LOAD_NAME</span> <span class="o">=</span> <span class="n">LOAD_GLOBAL</span> <span class="o">=</span> <span class="n">LOAD_FAST</span> <span class="o">=</span> \
        <span class="n">LOAD_CLOSURE</span> <span class="o">=</span> <span class="n">LOAD_DEREF</span> <span class="o">=</span> <span class="n">BUILD_MAP</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span><span class="mi">1</span>

    <span class="n">DELETE_FAST</span> <span class="o">=</span> <span class="n">DELETE_GLOBAL</span> <span class="o">=</span> <span class="n">DELETE_NAME</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span><span class="mi">0</span>

    <span class="n">EXEC_STMT</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span><span class="mi">0</span>
    <span class="n">BUILD_CLASS</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span><span class="mi">1</span>

    <span class="n">STORE_MAP</span> <span class="o">=</span> <span class="n">MAP_ADD</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span><span class="mi">0</span>
    <span class="n">SET_ADD</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span><span class="mi">0</span>

    <span class="k">if</span>   <span class="n">python_version</span> <span class="o">==</span> <span class="s">&#39;2.4&#39;</span><span class="p">:</span>
      <span class="n">YIELD_VALUE</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span><span class="mi">0</span>
      <span class="n">IMPORT_NAME</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span><span class="mi">1</span>
      <span class="n">LIST_APPEND</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span><span class="mi">0</span>
    <span class="k">elif</span> <span class="n">python_version</span> <span class="o">==</span> <span class="s">&#39;2.5&#39;</span><span class="p">:</span>
      <span class="n">YIELD_VALUE</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span><span class="mi">1</span>
      <span class="n">IMPORT_NAME</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span><span class="mi">1</span>
      <span class="n">LIST_APPEND</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span><span class="mi">0</span>
    <span class="k">elif</span> <span class="n">python_version</span> <span class="o">==</span> <span class="s">&#39;2.6&#39;</span><span class="p">:</span>
      <span class="n">YIELD_VALUE</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span><span class="mi">1</span>
      <span class="n">IMPORT_NAME</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span><span class="mi">1</span>
      <span class="n">LIST_APPEND</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span><span class="mi">0</span>
    <span class="k">elif</span> <span class="n">python_version</span> <span class="o">==</span> <span class="s">&#39;2.7&#39;</span><span class="p">:</span>
      <span class="n">YIELD_VALUE</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span><span class="mi">1</span>
      <span class="n">IMPORT_NAME</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span><span class="mi">1</span>
      <span class="n">LIST_APPEND</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span><span class="mi">0</span>


<span class="n">_se</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">((</span><span class="n">op</span><span class="p">,</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">_se</span><span class="p">,</span> <span class="n">opname</span><span class="p">[</span><span class="n">op</span><span class="p">]))</span>
           <span class="k">for</span> <span class="n">op</span> <span class="ow">in</span> <span class="n">opcodes</span>
           <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">_se</span><span class="p">,</span> <span class="n">opname</span><span class="p">[</span><span class="n">op</span><span class="p">]))</span>

<span class="n">hasflow</span> <span class="o">=</span> <span class="n">opcodes</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="n">_se</span><span class="p">)</span> <span class="o">-</span> \
          <span class="nb">set</span><span class="p">([</span><span class="n">CALL_FUNCTION</span><span class="p">,</span> <span class="n">CALL_FUNCTION_VAR</span><span class="p">,</span> <span class="n">CALL_FUNCTION_KW</span><span class="p">,</span>
               <span class="n">CALL_FUNCTION_VAR_KW</span><span class="p">,</span> <span class="n">BUILD_TUPLE</span><span class="p">,</span> <span class="n">BUILD_LIST</span><span class="p">,</span>
               <span class="n">UNPACK_SEQUENCE</span><span class="p">,</span> <span class="n">BUILD_SLICE</span><span class="p">,</span> <span class="n">DUP_TOPX</span><span class="p">,</span>
               <span class="n">RAISE_VARARGS</span><span class="p">,</span> <span class="n">MAKE_FUNCTION</span><span class="p">,</span> <span class="n">MAKE_CLOSURE</span><span class="p">])</span>
<span class="k">if</span> <span class="n">python_version</span> <span class="o">==</span> <span class="s">&#39;2.7&#39;</span><span class="p">:</span>
  <span class="n">hasflow</span> <span class="o">=</span> <span class="n">hasflow</span> <span class="o">-</span> <span class="nb">set</span><span class="p">([</span><span class="n">BUILD_SET</span><span class="p">])</span>

<div class="viewcode-block" id="getse"><a class="viewcode-back" href="../../../api_ref/enaml.core.html#enaml.core.byteplay.getse">[docs]</a><span class="k">def</span> <span class="nf">getse</span><span class="p">(</span><span class="n">op</span><span class="p">,</span> <span class="n">arg</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Get the stack effect of an opcode, as a (pop, push) tuple.</span>

<span class="sd">    If an arg is needed and is not given, a ValueError is raised.</span>
<span class="sd">    If op isn&#39;t a simple opcode, that is, the flow doesn&#39;t always continue</span>
<span class="sd">    to the next opcode, a ValueError is raised.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">_se</span><span class="p">[</span><span class="n">op</span><span class="p">]</span>
    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
        <span class="c"># Continue to opcodes with an effect that depends on arg</span>
        <span class="k">pass</span>

    <span class="k">if</span> <span class="n">arg</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">,</span> <span class="s">&quot;Opcode stack behaviour depends on arg&quot;</span>

    <span class="k">def</span> <span class="nf">get_func_tup</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="n">nextra</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">arg</span> <span class="o">&gt;</span> <span class="mh">0xFFFF</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">,</span> <span class="s">&quot;Can only split a two-byte argument&quot;</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">nextra</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">+</span> <span class="p">(</span><span class="n">arg</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span><span class="o">*</span><span class="p">((</span><span class="n">arg</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">),</span>
                <span class="mi">1</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">op</span> <span class="o">==</span> <span class="n">CALL_FUNCTION</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">get_func_tup</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">op</span> <span class="o">==</span> <span class="n">CALL_FUNCTION_VAR</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">get_func_tup</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">op</span> <span class="o">==</span> <span class="n">CALL_FUNCTION_KW</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">get_func_tup</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">op</span> <span class="o">==</span> <span class="n">CALL_FUNCTION_VAR_KW</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">get_func_tup</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>

    <span class="k">elif</span> <span class="n">op</span> <span class="o">==</span> <span class="n">BUILD_TUPLE</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">arg</span><span class="p">,</span> <span class="mi">1</span>
    <span class="k">elif</span> <span class="n">op</span> <span class="o">==</span> <span class="n">BUILD_LIST</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">arg</span><span class="p">,</span> <span class="mi">1</span>
    <span class="k">elif</span> <span class="n">python_version</span> <span class="o">==</span> <span class="s">&#39;2.7&#39;</span> <span class="ow">and</span> <span class="n">op</span> <span class="o">==</span> <span class="n">BUILD_SET</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">arg</span><span class="p">,</span> <span class="mi">1</span>
    <span class="k">elif</span> <span class="n">op</span> <span class="o">==</span> <span class="n">UNPACK_SEQUENCE</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">1</span><span class="p">,</span> <span class="n">arg</span>
    <span class="k">elif</span> <span class="n">op</span> <span class="o">==</span> <span class="n">BUILD_SLICE</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">arg</span><span class="p">,</span> <span class="mi">1</span>
    <span class="k">elif</span> <span class="n">op</span> <span class="o">==</span> <span class="n">DUP_TOPX</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">arg</span><span class="p">,</span> <span class="n">arg</span><span class="o">*</span><span class="mi">2</span>
    <span class="k">elif</span> <span class="n">op</span> <span class="o">==</span> <span class="n">RAISE_VARARGS</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">1</span><span class="o">+</span><span class="n">arg</span><span class="p">,</span> <span class="mi">1</span>
    <span class="k">elif</span> <span class="n">op</span> <span class="o">==</span> <span class="n">MAKE_FUNCTION</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">1</span><span class="o">+</span><span class="n">arg</span><span class="p">,</span> <span class="mi">1</span>
    <span class="k">elif</span> <span class="n">op</span> <span class="o">==</span> <span class="n">MAKE_CLOSURE</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">python_version</span> <span class="o">==</span> <span class="s">&#39;2.4&#39;</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">,</span> <span class="s">&quot;The stack effect of MAKE_CLOSURE depends on TOS&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">2</span><span class="o">+</span><span class="n">arg</span><span class="p">,</span> <span class="mi">1</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">,</span> <span class="s">&quot;The opcode </span><span class="si">%r</span><span class="s"> isn&#39;t recognized or has a special &quot;</span>\
              <span class="s">&quot;flow control&quot;</span> <span class="o">%</span> <span class="n">op</span>
</div>
<span class="k">class</span> <span class="nc">SetLinenoType</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s">&#39;SetLineno&#39;</span>
<span class="n">SetLineno</span> <span class="o">=</span> <span class="n">SetLinenoType</span><span class="p">()</span>

<div class="viewcode-block" id="Label"><a class="viewcode-back" href="../../../api_ref/enaml.core.html#enaml.core.byteplay.Label">[docs]</a><span class="k">class</span> <span class="nc">Label</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">pass</span>
</div>
<div class="viewcode-block" id="isopcode"><a class="viewcode-back" href="../../../api_ref/enaml.core.html#enaml.core.byteplay.isopcode">[docs]</a><span class="k">def</span> <span class="nf">isopcode</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return whether obj is an opcode - not SetLineno or Label&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">obj</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">SetLineno</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">Label</span><span class="p">)</span>

<span class="c"># Flags from code.h</span></div>
<span class="n">CO_OPTIMIZED</span>              <span class="o">=</span> <span class="mh">0x0001</span>      <span class="c"># use LOAD/STORE_FAST instead of _NAME</span>
<span class="n">CO_NEWLOCALS</span>              <span class="o">=</span> <span class="mh">0x0002</span>      <span class="c"># only cleared for module/exec code</span>
<span class="n">CO_VARARGS</span>                <span class="o">=</span> <span class="mh">0x0004</span>
<span class="n">CO_VARKEYWORDS</span>            <span class="o">=</span> <span class="mh">0x0008</span>
<span class="n">CO_NESTED</span>                 <span class="o">=</span> <span class="mh">0x0010</span>      <span class="c"># ???</span>
<span class="n">CO_GENERATOR</span>              <span class="o">=</span> <span class="mh">0x0020</span>
<span class="n">CO_NOFREE</span>                 <span class="o">=</span> <span class="mh">0x0040</span>      <span class="c"># set if no free or cell vars</span>
<span class="n">CO_GENERATOR_ALLOWED</span>      <span class="o">=</span> <span class="mh">0x1000</span>      <span class="c"># unused</span>
<span class="c"># The future flags are only used on code generation, so we can ignore them.</span>
<span class="c"># (It does cause some warnings, though.)</span>
<span class="n">CO_FUTURE_DIVISION</span>        <span class="o">=</span> <span class="mh">0x2000</span>
<span class="n">CO_FUTURE_ABSOLUTE_IMPORT</span> <span class="o">=</span> <span class="mh">0x4000</span>
<span class="n">CO_FUTURE_WITH_STATEMENT</span>  <span class="o">=</span> <span class="mh">0x8000</span>


<span class="c">######################################################################</span>
<span class="c"># Define the Code class</span>

<div class="viewcode-block" id="Code"><a class="viewcode-back" href="../../../api_ref/enaml.core.html#enaml.core.byteplay.Code">[docs]</a><span class="k">class</span> <span class="nc">Code</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;An object which holds all the information which a Python code object</span>
<span class="sd">    holds, but in an easy-to-play-with representation.</span>

<span class="sd">    The attributes are:</span>

<span class="sd">    Affecting action</span>
<span class="sd">    ----------------</span>
<span class="sd">    code - list of 2-tuples: the code</span>
<span class="sd">    freevars - list of strings: the free vars of the code (those are names</span>
<span class="sd">               of variables created in outer functions and used in the function)</span>
<span class="sd">    args - list of strings: the arguments of the code</span>
<span class="sd">    varargs - boolean: Does args end with a &#39;*args&#39; argument</span>
<span class="sd">    varkwargs - boolean: Does args end with a &#39;**kwargs&#39; argument</span>
<span class="sd">    newlocals - boolean: Should a new local namespace be created.</span>
<span class="sd">                (True in functions, False for module and exec code)</span>

<span class="sd">    Not affecting action</span>
<span class="sd">    --------------------</span>
<span class="sd">    name - string: the name of the code (co_name)</span>
<span class="sd">    filename - string: the file name of the code (co_filename)</span>
<span class="sd">    firstlineno - int: the first line number (co_firstlineno)</span>
<span class="sd">    docstring - string or None: the docstring (the first item of co_consts,</span>
<span class="sd">                if it&#39;s str or unicode)</span>

<span class="sd">    code is a list of 2-tuples. The first item is an opcode, or SetLineno, or a</span>
<span class="sd">    Label instance. The second item is the argument, if applicable, or None.</span>
<span class="sd">    code can be a CodeList instance, which will produce nicer output when</span>
<span class="sd">    being printed.</span>
<span class="sd">    &quot;&quot;&quot;</span>
<div class="viewcode-block" id="Code.__init__"><a class="viewcode-back" href="../../../api_ref/enaml.core.html#enaml.core.byteplay.Code.__init__">[docs]</a>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">code</span><span class="p">,</span> <span class="n">freevars</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">varargs</span><span class="p">,</span> <span class="n">varkwargs</span><span class="p">,</span> <span class="n">newlocals</span><span class="p">,</span>
                 <span class="n">name</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">firstlineno</span><span class="p">,</span> <span class="n">docstring</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">code</span> <span class="o">=</span> <span class="n">code</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">freevars</span> <span class="o">=</span> <span class="n">freevars</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">args</span> <span class="o">=</span> <span class="n">args</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">varargs</span> <span class="o">=</span> <span class="n">varargs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">varkwargs</span> <span class="o">=</span> <span class="n">varkwargs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">newlocals</span> <span class="o">=</span> <span class="n">newlocals</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">filename</span> <span class="o">=</span> <span class="n">filename</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">firstlineno</span> <span class="o">=</span> <span class="n">firstlineno</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">docstring</span> <span class="o">=</span> <span class="n">docstring</span>
</div>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_findlinestarts</span><span class="p">(</span><span class="n">code</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Find the offsets in a byte code which are start of lines in the</span>
<span class="sd">        source.</span>

<span class="sd">        Generate pairs (offset, lineno) as described in Python/compile.c.</span>

<span class="sd">        This is a modified version of dis.findlinestarts, which allows multiple</span>
<span class="sd">        &quot;line starts&quot; with the same line number.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">byte_increments</span> <span class="o">=</span> <span class="p">[</span><span class="nb">ord</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">code</span><span class="o">.</span><span class="n">co_lnotab</span><span class="p">[</span><span class="mi">0</span><span class="p">::</span><span class="mi">2</span><span class="p">]]</span>
        <span class="n">line_increments</span> <span class="o">=</span> <span class="p">[</span><span class="nb">ord</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">code</span><span class="o">.</span><span class="n">co_lnotab</span><span class="p">[</span><span class="mi">1</span><span class="p">::</span><span class="mi">2</span><span class="p">]]</span>

        <span class="n">lineno</span> <span class="o">=</span> <span class="n">code</span><span class="o">.</span><span class="n">co_firstlineno</span>
        <span class="n">addr</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">byte_incr</span><span class="p">,</span> <span class="n">line_incr</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">byte_increments</span><span class="p">,</span> <span class="n">line_increments</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">byte_incr</span><span class="p">:</span>
                <span class="k">yield</span> <span class="p">(</span><span class="n">addr</span><span class="p">,</span> <span class="n">lineno</span><span class="p">)</span>
                <span class="n">addr</span> <span class="o">+=</span> <span class="n">byte_incr</span>
            <span class="n">lineno</span> <span class="o">+=</span> <span class="n">line_incr</span>
        <span class="k">yield</span> <span class="p">(</span><span class="n">addr</span><span class="p">,</span> <span class="n">lineno</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
<div class="viewcode-block" id="Code.from_code"><a class="viewcode-back" href="../../../api_ref/enaml.core.html#enaml.core.byteplay.Code.from_code">[docs]</a>    <span class="k">def</span> <span class="nf">from_code</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">co</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Disassemble a Python code object into a Code object.&quot;&quot;&quot;</span>
        <span class="n">co_code</span> <span class="o">=</span> <span class="n">co</span><span class="o">.</span><span class="n">co_code</span>
        <span class="n">labels</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">((</span><span class="n">addr</span><span class="p">,</span> <span class="n">Label</span><span class="p">())</span> <span class="k">for</span> <span class="n">addr</span> <span class="ow">in</span> <span class="n">findlabels</span><span class="p">(</span><span class="n">co_code</span><span class="p">))</span>
        <span class="n">linestarts</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">cls</span><span class="o">.</span><span class="n">_findlinestarts</span><span class="p">(</span><span class="n">co</span><span class="p">))</span>
        <span class="n">cellfree</span> <span class="o">=</span> <span class="n">co</span><span class="o">.</span><span class="n">co_cellvars</span> <span class="o">+</span> <span class="n">co</span><span class="o">.</span><span class="n">co_freevars</span>

        <span class="n">code</span> <span class="o">=</span> <span class="n">CodeList</span><span class="p">()</span>
        <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">co_code</span><span class="p">)</span>
        <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">extended_arg</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">n</span><span class="p">:</span>
            <span class="n">op</span> <span class="o">=</span> <span class="n">Opcode</span><span class="p">(</span><span class="nb">ord</span><span class="p">(</span><span class="n">co_code</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
            <span class="k">if</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">labels</span><span class="p">:</span>
                <span class="n">code</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">labels</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="bp">None</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">linestarts</span><span class="p">:</span>
                <span class="n">code</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">SetLineno</span><span class="p">,</span> <span class="n">linestarts</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
            <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">op</span> <span class="ow">in</span> <span class="n">hascode</span><span class="p">:</span>
                <span class="n">lastop</span><span class="p">,</span> <span class="n">lastarg</span> <span class="o">=</span> <span class="n">code</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">lastop</span> <span class="o">!=</span> <span class="n">LOAD_CONST</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">,</span> \
                          <span class="s">&quot;</span><span class="si">%s</span><span class="s"> should be preceded by LOAD_CONST code&quot;</span> <span class="o">%</span> <span class="n">op</span>
                <span class="n">code</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">LOAD_CONST</span><span class="p">,</span> <span class="n">Code</span><span class="o">.</span><span class="n">from_code</span><span class="p">(</span><span class="n">lastarg</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">op</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">hasarg</span><span class="p">:</span>
                <span class="n">code</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">op</span><span class="p">,</span> <span class="bp">None</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">arg</span> <span class="o">=</span> <span class="nb">ord</span><span class="p">(</span><span class="n">co_code</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">+</span> <span class="nb">ord</span><span class="p">(</span><span class="n">co_code</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span><span class="o">*</span><span class="mi">256</span> <span class="o">+</span> <span class="n">extended_arg</span>
                <span class="n">extended_arg</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">i</span> <span class="o">+=</span> <span class="mi">2</span>
                <span class="k">if</span> <span class="n">op</span> <span class="o">==</span> <span class="n">opcode</span><span class="o">.</span><span class="n">EXTENDED_ARG</span><span class="p">:</span>
                    <span class="n">extended_arg</span> <span class="o">=</span> <span class="n">arg</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span>
                <span class="k">elif</span> <span class="n">op</span> <span class="ow">in</span> <span class="n">hasconst</span><span class="p">:</span>
                    <span class="n">code</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">op</span><span class="p">,</span> <span class="n">co</span><span class="o">.</span><span class="n">co_consts</span><span class="p">[</span><span class="n">arg</span><span class="p">]))</span>
                <span class="k">elif</span> <span class="n">op</span> <span class="ow">in</span> <span class="n">hasname</span><span class="p">:</span>
                    <span class="n">code</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">op</span><span class="p">,</span> <span class="n">co</span><span class="o">.</span><span class="n">co_names</span><span class="p">[</span><span class="n">arg</span><span class="p">]))</span>
                <span class="k">elif</span> <span class="n">op</span> <span class="ow">in</span> <span class="n">hasjabs</span><span class="p">:</span>
                    <span class="n">code</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">op</span><span class="p">,</span> <span class="n">labels</span><span class="p">[</span><span class="n">arg</span><span class="p">]))</span>
                <span class="k">elif</span> <span class="n">op</span> <span class="ow">in</span> <span class="n">hasjrel</span><span class="p">:</span>
                    <span class="n">code</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">op</span><span class="p">,</span> <span class="n">labels</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="n">arg</span><span class="p">]))</span>
                <span class="k">elif</span> <span class="n">op</span> <span class="ow">in</span> <span class="n">haslocal</span><span class="p">:</span>
                    <span class="n">code</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">op</span><span class="p">,</span> <span class="n">co</span><span class="o">.</span><span class="n">co_varnames</span><span class="p">[</span><span class="n">arg</span><span class="p">]))</span>
                <span class="k">elif</span> <span class="n">op</span> <span class="ow">in</span> <span class="n">hascompare</span><span class="p">:</span>
                    <span class="n">code</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">op</span><span class="p">,</span> <span class="n">cmp_op</span><span class="p">[</span><span class="n">arg</span><span class="p">]))</span>
                <span class="k">elif</span> <span class="n">op</span> <span class="ow">in</span> <span class="n">hasfree</span><span class="p">:</span>
                    <span class="n">code</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">op</span><span class="p">,</span> <span class="n">cellfree</span><span class="p">[</span><span class="n">arg</span><span class="p">]))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">code</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">op</span><span class="p">,</span> <span class="n">arg</span><span class="p">))</span>

        <span class="n">varargs</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">co</span><span class="o">.</span><span class="n">co_flags</span> <span class="o">&amp;</span> <span class="n">CO_VARARGS</span><span class="p">)</span>
        <span class="n">varkwargs</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">co</span><span class="o">.</span><span class="n">co_flags</span> <span class="o">&amp;</span> <span class="n">CO_VARKEYWORDS</span><span class="p">)</span>
        <span class="n">newlocals</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">co</span><span class="o">.</span><span class="n">co_flags</span> <span class="o">&amp;</span> <span class="n">CO_NEWLOCALS</span><span class="p">)</span>
        <span class="n">args</span> <span class="o">=</span> <span class="n">co</span><span class="o">.</span><span class="n">co_varnames</span><span class="p">[:</span><span class="n">co</span><span class="o">.</span><span class="n">co_argcount</span> <span class="o">+</span> <span class="n">varargs</span> <span class="o">+</span> <span class="n">varkwargs</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">co</span><span class="o">.</span><span class="n">co_consts</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">co</span><span class="o">.</span><span class="n">co_consts</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">basestring</span><span class="p">):</span>
            <span class="n">docstring</span> <span class="o">=</span> <span class="n">co</span><span class="o">.</span><span class="n">co_consts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">docstring</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">return</span> <span class="n">cls</span><span class="p">(</span><span class="n">code</span> <span class="o">=</span> <span class="n">code</span><span class="p">,</span>
                   <span class="n">freevars</span> <span class="o">=</span> <span class="n">co</span><span class="o">.</span><span class="n">co_freevars</span><span class="p">,</span>
                   <span class="n">args</span> <span class="o">=</span> <span class="n">args</span><span class="p">,</span>
                   <span class="n">varargs</span> <span class="o">=</span> <span class="n">varargs</span><span class="p">,</span>
                   <span class="n">varkwargs</span> <span class="o">=</span> <span class="n">varkwargs</span><span class="p">,</span>
                   <span class="n">newlocals</span> <span class="o">=</span> <span class="n">newlocals</span><span class="p">,</span>
                   <span class="n">name</span> <span class="o">=</span> <span class="n">co</span><span class="o">.</span><span class="n">co_name</span><span class="p">,</span>
                   <span class="n">filename</span> <span class="o">=</span> <span class="n">co</span><span class="o">.</span><span class="n">co_filename</span><span class="p">,</span>
                   <span class="n">firstlineno</span> <span class="o">=</span> <span class="n">co</span><span class="o">.</span><span class="n">co_firstlineno</span><span class="p">,</span>
                   <span class="n">docstring</span> <span class="o">=</span> <span class="n">docstring</span><span class="p">,</span>
                   <span class="p">)</span>
</div>
<div class="viewcode-block" id="Code.__eq__"><a class="viewcode-back" href="../../../api_ref/enaml.core.html#enaml.core.byteplay.Code.__eq__">[docs]</a>    <span class="k">def</span> <span class="nf">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">freevars</span> <span class="o">!=</span> <span class="n">other</span><span class="o">.</span><span class="n">freevars</span> <span class="ow">or</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">args</span> <span class="o">!=</span> <span class="n">other</span><span class="o">.</span><span class="n">args</span> <span class="ow">or</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">varargs</span> <span class="o">!=</span> <span class="n">other</span><span class="o">.</span><span class="n">varargs</span> <span class="ow">or</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">varkwargs</span> <span class="o">!=</span> <span class="n">other</span><span class="o">.</span><span class="n">varkwargs</span> <span class="ow">or</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">newlocals</span> <span class="o">!=</span> <span class="n">other</span><span class="o">.</span><span class="n">newlocals</span> <span class="ow">or</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">!=</span> <span class="n">other</span><span class="o">.</span><span class="n">name</span> <span class="ow">or</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">filename</span> <span class="o">!=</span> <span class="n">other</span><span class="o">.</span><span class="n">filename</span> <span class="ow">or</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">firstlineno</span> <span class="o">!=</span> <span class="n">other</span><span class="o">.</span><span class="n">firstlineno</span> <span class="ow">or</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">docstring</span> <span class="o">!=</span> <span class="n">other</span><span class="o">.</span><span class="n">docstring</span> <span class="ow">or</span>
            <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">code</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">code</span><span class="p">)</span>
            <span class="p">):</span>
            <span class="k">return</span> <span class="bp">False</span>

        <span class="c"># Compare code. This isn&#39;t trivial because labels should be matching,</span>
        <span class="c"># not equal.</span>
        <span class="n">labelmapping</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">op1</span><span class="p">,</span> <span class="n">arg1</span><span class="p">),</span> <span class="p">(</span><span class="n">op2</span><span class="p">,</span> <span class="n">arg2</span><span class="p">)</span> <span class="ow">in</span> <span class="n">itertools</span><span class="o">.</span><span class="n">izip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">code</span><span class="p">,</span> <span class="n">other</span><span class="o">.</span><span class="n">code</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">op1</span><span class="p">,</span> <span class="n">Label</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">labelmapping</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">op1</span><span class="p">,</span> <span class="n">op2</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">op2</span><span class="p">:</span>
                    <span class="k">return</span> <span class="bp">False</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">op1</span> <span class="o">!=</span> <span class="n">op2</span><span class="p">:</span>
                    <span class="k">return</span> <span class="bp">False</span>
                <span class="k">if</span> <span class="n">op1</span> <span class="ow">in</span> <span class="n">hasjump</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">labelmapping</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">arg1</span><span class="p">,</span> <span class="n">arg2</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">arg2</span><span class="p">:</span>
                        <span class="k">return</span> <span class="bp">False</span>
                <span class="k">elif</span> <span class="n">op1</span> <span class="ow">in</span> <span class="n">hasarg</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">arg1</span> <span class="o">!=</span> <span class="n">arg2</span><span class="p">:</span>
                        <span class="k">return</span> <span class="bp">False</span>
        <span class="k">return</span> <span class="bp">True</span>
</div>
    <span class="k">def</span> <span class="nf">_compute_flags</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">opcodes</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">op</span> <span class="k">for</span> <span class="n">op</span><span class="p">,</span> <span class="n">arg</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">code</span> <span class="k">if</span> <span class="n">isopcode</span><span class="p">(</span><span class="n">op</span><span class="p">))</span>

        <span class="n">optimized</span> <span class="o">=</span> <span class="p">(</span><span class="n">STORE_NAME</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">opcodes</span> <span class="ow">and</span>
                     <span class="n">LOAD_NAME</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">opcodes</span> <span class="ow">and</span>
                     <span class="n">DELETE_NAME</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">opcodes</span><span class="p">)</span>
        <span class="n">generator</span> <span class="o">=</span> <span class="p">(</span><span class="n">YIELD_VALUE</span> <span class="ow">in</span> <span class="n">opcodes</span><span class="p">)</span>
        <span class="n">nofree</span> <span class="o">=</span> <span class="ow">not</span> <span class="p">(</span><span class="n">opcodes</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">hasfree</span><span class="p">))</span>

        <span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="n">optimized</span><span class="p">:</span> <span class="n">flags</span> <span class="o">|=</span> <span class="n">CO_OPTIMIZED</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">newlocals</span><span class="p">:</span> <span class="n">flags</span> <span class="o">|=</span> <span class="n">CO_NEWLOCALS</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">varargs</span><span class="p">:</span> <span class="n">flags</span> <span class="o">|=</span> <span class="n">CO_VARARGS</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">varkwargs</span><span class="p">:</span> <span class="n">flags</span> <span class="o">|=</span> <span class="n">CO_VARKEYWORDS</span>
        <span class="k">if</span> <span class="n">generator</span><span class="p">:</span> <span class="n">flags</span> <span class="o">|=</span> <span class="n">CO_GENERATOR</span>
        <span class="k">if</span> <span class="n">nofree</span><span class="p">:</span> <span class="n">flags</span> <span class="o">|=</span> <span class="n">CO_NOFREE</span>
        <span class="k">return</span> <span class="n">flags</span>

    <span class="k">def</span> <span class="nf">_compute_stacksize</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get a code list, compute its maximal stack usage.&quot;&quot;&quot;</span>
        <span class="c"># This is done by scanning the code, and computing for each opcode</span>
        <span class="c"># the stack state at the opcode.</span>
        <span class="n">code</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">code</span>

        <span class="c"># A mapping from labels to their positions in the code list</span>
        <span class="n">label_pos</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">((</span><span class="n">op</span><span class="p">,</span> <span class="n">pos</span><span class="p">)</span>
                         <span class="k">for</span> <span class="n">pos</span><span class="p">,</span> <span class="p">(</span><span class="n">op</span><span class="p">,</span> <span class="n">arg</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">code</span><span class="p">)</span>
                         <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">op</span><span class="p">,</span> <span class="n">Label</span><span class="p">))</span>

        <span class="c"># sf_targets are the targets of SETUP_FINALLY opcodes. They are recorded</span>
        <span class="c"># because they have special stack behaviour. If an exception was raised</span>
        <span class="c"># in the block pushed by a SETUP_FINALLY opcode, the block is popped</span>
        <span class="c"># and 3 objects are pushed. On return or continue, the block is popped</span>
        <span class="c"># and 2 objects are pushed. If nothing happened, the block is popped by</span>
        <span class="c"># a POP_BLOCK opcode and 1 object is pushed by a (LOAD_CONST, None)</span>
        <span class="c"># operation.</span>
        <span class="c">#</span>
        <span class="c"># Our solution is to record the stack state of SETUP_FINALLY targets</span>
        <span class="c"># as having 3 objects pushed, which is the maximum. However, to make</span>
        <span class="c"># stack recording consistent, the get_next_stacks function will always</span>
        <span class="c"># yield the stack state of the target as if 1 object was pushed, but</span>
        <span class="c"># this will be corrected in the actual stack recording.</span>

        <span class="n">sf_targets</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">label_pos</span><span class="p">[</span><span class="n">arg</span><span class="p">]</span>
                         <span class="k">for</span> <span class="n">op</span><span class="p">,</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">code</span>
                         <span class="k">if</span> <span class="n">op</span> <span class="o">==</span> <span class="n">SETUP_FINALLY</span><span class="p">)</span>

        <span class="c"># What we compute - for each opcode, its stack state, as an n-tuple.</span>
        <span class="c"># n is the number of blocks pushed. For each block, we record the number</span>
        <span class="c"># of objects pushed.</span>
        <span class="n">stacks</span> <span class="o">=</span> <span class="p">[</span><span class="bp">None</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">code</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">get_next_stacks</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="n">curstack</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;Get a code position and the stack state before the operation</span>
<span class="sd">            was done, and yield pairs (pos, curstack) for the next positions</span>
<span class="sd">            to be explored - those are the positions to which you can get</span>
<span class="sd">            from the given (pos, curstack).</span>

<span class="sd">            If the given position was already explored, nothing will be yielded.</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="n">op</span><span class="p">,</span> <span class="n">arg</span> <span class="o">=</span> <span class="n">code</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span>

            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">op</span><span class="p">,</span> <span class="n">Label</span><span class="p">):</span>
                <span class="c"># We should check if we already reached a node only if it is</span>
                <span class="c"># a label.</span>
                <span class="k">if</span> <span class="n">pos</span> <span class="ow">in</span> <span class="n">sf_targets</span><span class="p">:</span>
                    <span class="n">curstack</span> <span class="o">=</span> <span class="n">curstack</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">curstack</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,)</span>
                <span class="k">if</span> <span class="n">stacks</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="n">stacks</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span> <span class="o">=</span> <span class="n">curstack</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">stacks</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span> <span class="o">!=</span> <span class="n">curstack</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">,</span> <span class="s">&quot;Inconsistent code&quot;</span>
                    <span class="k">return</span>

            <span class="k">def</span> <span class="nf">newstack</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
                <span class="c"># Return a new stack, modified by adding n elements to the last</span>
                <span class="c"># block</span>
                <span class="k">if</span> <span class="n">curstack</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">,</span> <span class="s">&quot;Popped a non-existing element&quot;</span>
                <span class="k">return</span> <span class="n">curstack</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">curstack</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">n</span><span class="p">,)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">isopcode</span><span class="p">(</span><span class="n">op</span><span class="p">):</span>
                <span class="c"># label or SetLineno - just continue to next line</span>
                <span class="k">yield</span> <span class="n">pos</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">curstack</span>

            <span class="k">elif</span> <span class="n">op</span> <span class="ow">in</span> <span class="p">(</span><span class="n">STOP_CODE</span><span class="p">,</span> <span class="n">RETURN_VALUE</span><span class="p">,</span> <span class="n">RAISE_VARARGS</span><span class="p">):</span>
                <span class="c"># No place in particular to continue to</span>
                <span class="k">pass</span>

            <span class="k">elif</span> <span class="n">op</span> <span class="o">==</span> <span class="n">MAKE_CLOSURE</span> <span class="ow">and</span> <span class="n">python_version</span> <span class="o">==</span> <span class="s">&#39;2.4&#39;</span><span class="p">:</span>
                <span class="c"># This is only relevant in Python 2.4 - in Python 2.5 the stack</span>
                <span class="c"># effect of MAKE_CLOSURE can be calculated from the arg.</span>
                <span class="c"># In Python 2.4, it depends on the number of freevars of TOS,</span>
                <span class="c"># which should be a code object.</span>
                <span class="k">if</span> <span class="n">pos</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">,</span> \
                          <span class="s">&quot;MAKE_CLOSURE can&#39;t be the first opcode&quot;</span>
                <span class="n">lastop</span><span class="p">,</span> <span class="n">lastarg</span> <span class="o">=</span> <span class="n">code</span><span class="p">[</span><span class="n">pos</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">lastop</span> <span class="o">!=</span> <span class="n">LOAD_CONST</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">,</span> \
                          <span class="s">&quot;MAKE_CLOSURE should come after a LOAD_CONST op&quot;</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">nextrapops</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">lastarg</span><span class="o">.</span><span class="n">freevars</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">nextrapops</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">lastarg</span><span class="o">.</span><span class="n">co_freevars</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">,</span> \
                              <span class="s">&quot;MAKE_CLOSURE preceding const should &quot;</span>\
                              <span class="s">&quot;be a code or a Code object&quot;</span>

                <span class="k">yield</span> <span class="n">pos</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">newstack</span><span class="p">(</span><span class="o">-</span><span class="n">arg</span><span class="o">-</span><span class="n">nextrapops</span><span class="p">)</span>

            <span class="k">elif</span> <span class="n">op</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">hasflow</span><span class="p">:</span>
                <span class="c"># Simple change of stack</span>
                <span class="n">pop</span><span class="p">,</span> <span class="n">push</span> <span class="o">=</span> <span class="n">getse</span><span class="p">(</span><span class="n">op</span><span class="p">,</span> <span class="n">arg</span><span class="p">)</span>
                <span class="k">yield</span> <span class="n">pos</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">newstack</span><span class="p">(</span><span class="n">push</span> <span class="o">-</span> <span class="n">pop</span><span class="p">)</span>

            <span class="k">elif</span> <span class="n">op</span> <span class="ow">in</span> <span class="p">(</span><span class="n">JUMP_FORWARD</span><span class="p">,</span> <span class="n">JUMP_ABSOLUTE</span><span class="p">):</span>
                <span class="c"># One possibility for a jump</span>
                <span class="k">yield</span> <span class="n">label_pos</span><span class="p">[</span><span class="n">arg</span><span class="p">],</span> <span class="n">curstack</span>

            <span class="k">elif</span> <span class="n">python_version</span> <span class="o">&lt;</span> <span class="s">&#39;2.7&#39;</span> <span class="ow">and</span> <span class="n">op</span> <span class="ow">in</span> <span class="p">(</span><span class="n">JUMP_IF_FALSE</span><span class="p">,</span> <span class="n">JUMP_IF_TRUE</span><span class="p">):</span>
                <span class="c"># Two possibilities for a jump</span>
                <span class="k">yield</span> <span class="n">label_pos</span><span class="p">[</span><span class="n">arg</span><span class="p">],</span> <span class="n">curstack</span>
                <span class="k">yield</span> <span class="n">pos</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">curstack</span>

            <span class="k">elif</span> <span class="n">python_version</span> <span class="o">&gt;=</span> <span class="s">&#39;2.7&#39;</span> <span class="ow">and</span> <span class="n">op</span> <span class="ow">in</span> <span class="p">(</span><span class="n">POP_JUMP_IF_FALSE</span><span class="p">,</span> <span class="n">POP_JUMP_IF_TRUE</span><span class="p">):</span>
                <span class="c"># Two possibilities for a jump</span>
                <span class="k">yield</span> <span class="n">label_pos</span><span class="p">[</span><span class="n">arg</span><span class="p">],</span> <span class="n">newstack</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
                <span class="k">yield</span> <span class="n">pos</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">newstack</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>

            <span class="k">elif</span> <span class="n">python_version</span> <span class="o">&gt;=</span> <span class="s">&#39;2.7&#39;</span> <span class="ow">and</span> <span class="n">op</span> <span class="ow">in</span> <span class="p">(</span><span class="n">JUMP_IF_TRUE_OR_POP</span><span class="p">,</span> <span class="n">JUMP_IF_FALSE_OR_POP</span><span class="p">):</span>
                <span class="c"># Two possibilities for a jump</span>
                <span class="k">yield</span> <span class="n">label_pos</span><span class="p">[</span><span class="n">arg</span><span class="p">],</span> <span class="n">curstack</span>
                <span class="k">yield</span> <span class="n">pos</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">newstack</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>

            <span class="k">elif</span> <span class="n">op</span> <span class="o">==</span> <span class="n">FOR_ITER</span><span class="p">:</span>
                <span class="c"># FOR_ITER pushes next(TOS) on success, and pops TOS and jumps</span>
                <span class="c"># on failure</span>
                <span class="k">yield</span> <span class="n">label_pos</span><span class="p">[</span><span class="n">arg</span><span class="p">],</span> <span class="n">newstack</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
                <span class="k">yield</span> <span class="n">pos</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">newstack</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

            <span class="k">elif</span> <span class="n">op</span> <span class="o">==</span> <span class="n">BREAK_LOOP</span><span class="p">:</span>
                <span class="c"># BREAK_LOOP jumps to a place specified on block creation, so</span>
                <span class="c"># it is ignored here</span>
                <span class="k">pass</span>

            <span class="k">elif</span> <span class="n">op</span> <span class="o">==</span> <span class="n">CONTINUE_LOOP</span><span class="p">:</span>
                <span class="c"># CONTINUE_LOOP jumps to the beginning of a loop which should</span>
                <span class="c"># already ave been discovered, but we verify anyway.</span>
                <span class="c"># It pops a block.</span>
                <span class="k">if</span> <span class="n">python_version</span> <span class="o">==</span> <span class="s">&#39;2.6&#39;</span><span class="p">:</span>
                  <span class="n">pos</span><span class="p">,</span> <span class="n">stack</span> <span class="o">=</span> <span class="n">label_pos</span><span class="p">[</span><span class="n">arg</span><span class="p">],</span> <span class="n">curstack</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                  <span class="k">if</span> <span class="n">stacks</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span> <span class="o">!=</span> <span class="n">stack</span><span class="p">:</span> <span class="c">#this could be a loop with a &#39;with&#39; inside</span>
                    <span class="k">yield</span> <span class="n">pos</span><span class="p">,</span> <span class="n">stack</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">stack</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">,)</span>
                  <span class="k">else</span><span class="p">:</span>
                    <span class="k">yield</span> <span class="n">pos</span><span class="p">,</span> <span class="n">stack</span>
                <span class="k">else</span><span class="p">:</span>
                  <span class="k">yield</span> <span class="n">label_pos</span><span class="p">[</span><span class="n">arg</span><span class="p">],</span> <span class="n">curstack</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

            <span class="k">elif</span> <span class="n">op</span> <span class="o">==</span> <span class="n">SETUP_LOOP</span><span class="p">:</span>
                <span class="c"># We continue with a new block.</span>
                <span class="c"># On break, we jump to the label and return to current stack</span>
                <span class="c"># state.</span>
                <span class="k">yield</span> <span class="n">label_pos</span><span class="p">[</span><span class="n">arg</span><span class="p">],</span> <span class="n">curstack</span>
                <span class="k">yield</span> <span class="n">pos</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">curstack</span> <span class="o">+</span> <span class="p">(</span><span class="mi">0</span><span class="p">,)</span>

            <span class="k">elif</span> <span class="n">op</span> <span class="o">==</span> <span class="n">SETUP_EXCEPT</span><span class="p">:</span>
                <span class="c"># We continue with a new block.</span>
                <span class="c"># On exception, we jump to the label with 3 extra objects on</span>
                <span class="c"># stack</span>
                <span class="k">yield</span> <span class="n">label_pos</span><span class="p">[</span><span class="n">arg</span><span class="p">],</span> <span class="n">newstack</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
                <span class="k">yield</span> <span class="n">pos</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">curstack</span> <span class="o">+</span> <span class="p">(</span><span class="mi">0</span><span class="p">,)</span>

            <span class="k">elif</span> <span class="n">op</span> <span class="o">==</span> <span class="n">SETUP_FINALLY</span><span class="p">:</span>
                <span class="c"># We continue with a new block.</span>
                <span class="c"># On exception, we jump to the label with 3 extra objects on</span>
                <span class="c"># stack, but to keep stack recording consistent, we behave as</span>
                <span class="c"># if we add only 1 object. Extra 2 will be added to the actual</span>
                <span class="c"># recording.</span>
                <span class="k">yield</span> <span class="n">label_pos</span><span class="p">[</span><span class="n">arg</span><span class="p">],</span> <span class="n">newstack</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                <span class="k">yield</span> <span class="n">pos</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">curstack</span> <span class="o">+</span> <span class="p">(</span><span class="mi">0</span><span class="p">,)</span>

            <span class="k">elif</span> <span class="n">python_version</span> <span class="o">==</span> <span class="s">&#39;2.7&#39;</span> <span class="ow">and</span> <span class="n">op</span> <span class="o">==</span> <span class="n">SETUP_WITH</span><span class="p">:</span>
                <span class="k">yield</span> <span class="n">label_pos</span><span class="p">[</span><span class="n">arg</span><span class="p">],</span> <span class="n">curstack</span>
                <span class="k">yield</span> <span class="n">pos</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">newstack</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span><span class="p">,)</span>

            <span class="k">elif</span> <span class="n">op</span> <span class="o">==</span> <span class="n">POP_BLOCK</span><span class="p">:</span>
                <span class="c"># Just pop the block</span>
                <span class="k">yield</span> <span class="n">pos</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">curstack</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

            <span class="k">elif</span> <span class="n">op</span> <span class="o">==</span> <span class="n">END_FINALLY</span><span class="p">:</span>
                <span class="c"># Since stack recording of SETUP_FINALLY targets is of 3 pushed</span>
                <span class="c"># objects (as when an exception is raised), we pop 3 objects.</span>
                <span class="k">yield</span> <span class="n">pos</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">newstack</span><span class="p">(</span><span class="o">-</span><span class="mi">3</span><span class="p">)</span>

            <span class="k">elif</span> <span class="n">op</span> <span class="o">==</span> <span class="n">WITH_CLEANUP</span><span class="p">:</span>
                <span class="c"># Since WITH_CLEANUP is always found after SETUP_FINALLY</span>
                <span class="c"># targets, and the stack recording is that of a raised</span>
                <span class="c"># exception, we can simply pop 1 object and let END_FINALLY</span>
                <span class="c"># pop the remaining 3.</span>
                <span class="k">if</span> <span class="n">python_version</span> <span class="o">==</span> <span class="s">&#39;2.7&#39;</span><span class="p">:</span>
                  <span class="k">yield</span> <span class="n">pos</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">newstack</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                  <span class="k">yield</span> <span class="n">pos</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">newstack</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="k">assert</span> <span class="bp">False</span><span class="p">,</span> <span class="s">&quot;Unhandled opcode: </span><span class="si">%r</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">op</span>


        <span class="c"># Now comes the calculation: open_positions holds positions which are</span>
        <span class="c"># yet to be explored. In each step we take one open position, and</span>
        <span class="c"># explore it by adding the positions to which you can get from it, to</span>
        <span class="c"># open_positions. On the way, we update maxsize.</span>
        <span class="c"># open_positions is a list of tuples: (pos, stack state)</span>
        <span class="n">maxsize</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">open_positions</span> <span class="o">=</span> <span class="p">[(</span><span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,))]</span>
        <span class="k">while</span> <span class="n">open_positions</span><span class="p">:</span>
            <span class="n">pos</span><span class="p">,</span> <span class="n">curstack</span> <span class="o">=</span> <span class="n">open_positions</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
            <span class="n">maxsize</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">maxsize</span><span class="p">,</span> <span class="nb">sum</span><span class="p">(</span><span class="n">curstack</span><span class="p">))</span>
            <span class="n">open_positions</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">get_next_stacks</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="n">curstack</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">maxsize</span>

<div class="viewcode-block" id="Code.to_code"><a class="viewcode-back" href="../../../api_ref/enaml.core.html#enaml.core.byteplay.Code.to_code">[docs]</a>    <span class="k">def</span> <span class="nf">to_code</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Assemble a Python code object from a Code object.&quot;&quot;&quot;</span>
        <span class="n">co_argcount</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">)</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">varargs</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">varkwargs</span>
        <span class="n">co_stacksize</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compute_stacksize</span><span class="p">()</span>
        <span class="n">co_flags</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compute_flags</span><span class="p">()</span>

        <span class="n">co_consts</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">docstring</span><span class="p">]</span>
        <span class="n">co_names</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">co_varnames</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">)</span>

        <span class="n">co_freevars</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">freevars</span><span class="p">)</span>

        <span class="c"># We find all cellvars beforehand, for two reasons:</span>
        <span class="c"># 1. We need the number of them to construct the numeric argument</span>
        <span class="c">#    for ops in &quot;hasfree&quot;.</span>
        <span class="c"># 2. We need to put arguments which are cell vars in the beginning</span>
        <span class="c">#    of co_cellvars</span>
        <span class="n">cellvars</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">arg</span> <span class="k">for</span> <span class="n">op</span><span class="p">,</span> <span class="n">arg</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">code</span>
                       <span class="k">if</span> <span class="n">isopcode</span><span class="p">(</span><span class="n">op</span><span class="p">)</span> <span class="ow">and</span> <span class="n">op</span> <span class="ow">in</span> <span class="n">hasfree</span>
                       <span class="ow">and</span> <span class="n">arg</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">co_freevars</span><span class="p">)</span>
        <span class="n">co_cellvars</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span> <span class="k">if</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">cellvars</span><span class="p">]</span>

        <span class="k">def</span> <span class="nf">index</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="n">item</span><span class="p">,</span> <span class="n">eq</span><span class="o">=</span><span class="n">operator</span><span class="o">.</span><span class="n">eq</span><span class="p">,</span> <span class="n">can_append</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;Find the index of item in a sequence and return it.</span>
<span class="sd">            If it is not found in the sequence, and can_append is True,</span>
<span class="sd">            it is appended to the sequence.</span>

<span class="sd">            eq is the equality operator to use.</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">seq</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">eq</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">item</span><span class="p">):</span>
                    <span class="k">return</span> <span class="n">i</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">can_append</span><span class="p">:</span>
                    <span class="n">seq</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
                    <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">seq</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">IndexError</span><span class="p">,</span> <span class="s">&quot;Item not found&quot;</span>

        <span class="c"># List of tuples (pos, label) to be filled later</span>
        <span class="n">jumps</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c"># A mapping from a label to its position</span>
        <span class="n">label_pos</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="c"># Last SetLineno</span>
        <span class="n">lastlineno</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">firstlineno</span>
        <span class="n">lastlinepos</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="n">co_code</span> <span class="o">=</span> <span class="n">array</span><span class="p">(</span><span class="s">&#39;B&#39;</span><span class="p">)</span>
        <span class="n">co_lnotab</span> <span class="o">=</span> <span class="n">array</span><span class="p">(</span><span class="s">&#39;B&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">op</span><span class="p">,</span> <span class="n">arg</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">code</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">op</span><span class="p">,</span> <span class="n">Label</span><span class="p">):</span>
                <span class="n">label_pos</span><span class="p">[</span><span class="n">op</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">co_code</span><span class="p">)</span>

            <span class="k">elif</span> <span class="n">op</span> <span class="ow">is</span> <span class="n">SetLineno</span><span class="p">:</span>
                <span class="n">incr_lineno</span> <span class="o">=</span> <span class="n">arg</span> <span class="o">-</span> <span class="n">lastlineno</span>
                <span class="n">incr_pos</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">co_code</span><span class="p">)</span> <span class="o">-</span> <span class="n">lastlinepos</span>
                <span class="n">lastlineno</span> <span class="o">=</span> <span class="n">arg</span>
                <span class="n">lastlinepos</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">co_code</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">incr_lineno</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">incr_pos</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">co_lnotab</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                    <span class="n">co_lnotab</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">while</span> <span class="n">incr_pos</span> <span class="o">&gt;</span> <span class="mi">255</span><span class="p">:</span>
                        <span class="n">co_lnotab</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">255</span><span class="p">)</span>
                        <span class="n">co_lnotab</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                        <span class="n">incr_pos</span> <span class="o">-=</span> <span class="mi">255</span>
                    <span class="k">while</span> <span class="n">incr_lineno</span> <span class="o">&gt;</span> <span class="mi">255</span><span class="p">:</span>
                        <span class="n">co_lnotab</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">incr_pos</span><span class="p">)</span>
                        <span class="n">co_lnotab</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">255</span><span class="p">)</span>
                        <span class="n">incr_pos</span> <span class="o">=</span> <span class="mi">0</span>
                        <span class="n">incr_lineno</span> <span class="o">-=</span> <span class="mi">255</span>
                    <span class="k">if</span> <span class="n">incr_pos</span> <span class="ow">or</span> <span class="n">incr_lineno</span><span class="p">:</span>
                        <span class="n">co_lnotab</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">incr_pos</span><span class="p">)</span>
                        <span class="n">co_lnotab</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">incr_lineno</span><span class="p">)</span>

            <span class="k">elif</span> <span class="n">op</span> <span class="o">==</span> <span class="n">opcode</span><span class="o">.</span><span class="n">EXTENDED_ARG</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">,</span> <span class="s">&quot;EXTENDED_ARG not supported in Code objects&quot;</span>

            <span class="k">elif</span> <span class="ow">not</span> <span class="n">op</span> <span class="ow">in</span> <span class="n">hasarg</span><span class="p">:</span>
                <span class="n">co_code</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">op</span><span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">op</span> <span class="ow">in</span> <span class="n">hasconst</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="n">Code</span><span class="p">)</span> <span class="ow">and</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">code</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span> <span class="ow">and</span> \
                       <span class="bp">self</span><span class="o">.</span><span class="n">code</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="n">hascode</span><span class="p">:</span>
                        <span class="n">arg</span> <span class="o">=</span> <span class="n">arg</span><span class="o">.</span><span class="n">to_code</span><span class="p">()</span>
                    <span class="n">arg</span> <span class="o">=</span> <span class="n">index</span><span class="p">(</span><span class="n">co_consts</span><span class="p">,</span> <span class="n">arg</span><span class="p">,</span> <span class="n">operator</span><span class="o">.</span><span class="n">is_</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">op</span> <span class="ow">in</span> <span class="n">hasname</span><span class="p">:</span>
                    <span class="n">arg</span> <span class="o">=</span> <span class="n">index</span><span class="p">(</span><span class="n">co_names</span><span class="p">,</span> <span class="n">arg</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">op</span> <span class="ow">in</span> <span class="n">hasjump</span><span class="p">:</span>
                    <span class="c"># arg will be filled later</span>
                    <span class="n">jumps</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">co_code</span><span class="p">),</span> <span class="n">arg</span><span class="p">))</span>
                    <span class="n">arg</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">elif</span> <span class="n">op</span> <span class="ow">in</span> <span class="n">haslocal</span><span class="p">:</span>
                    <span class="n">arg</span> <span class="o">=</span> <span class="n">index</span><span class="p">(</span><span class="n">co_varnames</span><span class="p">,</span> <span class="n">arg</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">op</span> <span class="ow">in</span> <span class="n">hascompare</span><span class="p">:</span>
                    <span class="n">arg</span> <span class="o">=</span> <span class="n">index</span><span class="p">(</span><span class="n">cmp_op</span><span class="p">,</span> <span class="n">arg</span><span class="p">,</span> <span class="n">can_append</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">op</span> <span class="ow">in</span> <span class="n">hasfree</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">arg</span> <span class="o">=</span> <span class="n">index</span><span class="p">(</span><span class="n">co_freevars</span><span class="p">,</span> <span class="n">arg</span><span class="p">,</span> <span class="n">can_append</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span> \
                              <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">cellvars</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
                        <span class="n">arg</span> <span class="o">=</span> <span class="n">index</span><span class="p">(</span><span class="n">co_cellvars</span><span class="p">,</span> <span class="n">arg</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c"># arg is ok</span>
                    <span class="k">pass</span>

                <span class="k">if</span> <span class="n">arg</span> <span class="o">&gt;</span> <span class="mh">0xFFFF</span><span class="p">:</span>
                    <span class="n">co_code</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">opcode</span><span class="o">.</span><span class="n">EXTENDED_ARG</span><span class="p">)</span>
                    <span class="n">co_code</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">arg</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">)</span>
                    <span class="n">co_code</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">arg</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">)</span>
                <span class="n">co_code</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">op</span><span class="p">)</span>
                <span class="n">co_code</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">arg</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">)</span>
                <span class="n">co_code</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">arg</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">pos</span><span class="p">,</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">jumps</span><span class="p">:</span>
            <span class="n">jump</span> <span class="o">=</span> <span class="n">label_pos</span><span class="p">[</span><span class="n">label</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">co_code</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span> <span class="ow">in</span> <span class="n">hasjrel</span><span class="p">:</span>
                <span class="n">jump</span> <span class="o">-=</span> <span class="n">pos</span><span class="o">+</span><span class="mi">3</span>
            <span class="k">if</span> <span class="n">jump</span> <span class="o">&gt;</span> <span class="mh">0xFFFF</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">,</span> <span class="s">&quot;Extended jumps not implemented&quot;</span>
            <span class="n">co_code</span><span class="p">[</span><span class="n">pos</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">jump</span> <span class="o">&amp;</span> <span class="mh">0xFF</span>
            <span class="n">co_code</span><span class="p">[</span><span class="n">pos</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">jump</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span>

        <span class="n">co_code</span> <span class="o">=</span> <span class="n">co_code</span><span class="o">.</span><span class="n">tostring</span><span class="p">()</span>
        <span class="n">co_lnotab</span> <span class="o">=</span> <span class="n">co_lnotab</span><span class="o">.</span><span class="n">tostring</span><span class="p">()</span>

        <span class="n">co_consts</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">co_consts</span><span class="p">)</span>
        <span class="n">co_names</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">co_names</span><span class="p">)</span>
        <span class="n">co_varnames</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">co_varnames</span><span class="p">)</span>
        <span class="n">co_nlocals</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">co_varnames</span><span class="p">)</span>
        <span class="n">co_cellvars</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">co_cellvars</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">types</span><span class="o">.</span><span class="n">CodeType</span><span class="p">(</span><span class="n">co_argcount</span><span class="p">,</span> <span class="n">co_nlocals</span><span class="p">,</span> <span class="n">co_stacksize</span><span class="p">,</span> <span class="n">co_flags</span><span class="p">,</span>
                              <span class="n">co_code</span><span class="p">,</span> <span class="n">co_consts</span><span class="p">,</span> <span class="n">co_names</span><span class="p">,</span> <span class="n">co_varnames</span><span class="p">,</span>
                              <span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">firstlineno</span><span class="p">,</span> <span class="n">co_lnotab</span><span class="p">,</span>
                              <span class="n">co_freevars</span><span class="p">,</span> <span class="n">co_cellvars</span><span class="p">)</span>

</div></div>
<div class="viewcode-block" id="printcodelist"><a class="viewcode-back" href="../../../api_ref/enaml.core.html#enaml.core.byteplay.printcodelist">[docs]</a><span class="k">def</span> <span class="nf">printcodelist</span><span class="p">(</span><span class="n">codelist</span><span class="p">,</span> <span class="n">to</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Get a code list. Print it nicely.&quot;&quot;&quot;</span>

    <span class="n">labeldict</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">pendinglabels</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">op</span><span class="p">,</span> <span class="n">arg</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">codelist</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">op</span><span class="p">,</span> <span class="n">Label</span><span class="p">):</span>
            <span class="n">pendinglabels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">op</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">op</span> <span class="ow">is</span> <span class="n">SetLineno</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">while</span> <span class="n">pendinglabels</span><span class="p">:</span>
                <span class="n">labeldict</span><span class="p">[</span><span class="n">pendinglabels</span><span class="o">.</span><span class="n">pop</span><span class="p">()]</span> <span class="o">=</span> <span class="n">i</span>

    <span class="n">lineno</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">islabel</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">op</span><span class="p">,</span> <span class="n">arg</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">codelist</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">op</span> <span class="ow">is</span> <span class="n">SetLineno</span><span class="p">:</span>
            <span class="n">lineno</span> <span class="o">=</span> <span class="n">arg</span>
            <span class="k">print</span> <span class="o">&gt;&gt;</span> <span class="n">to</span>
            <span class="k">continue</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">op</span><span class="p">,</span> <span class="n">Label</span><span class="p">):</span>
            <span class="n">islabel</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="k">continue</span>

        <span class="k">if</span> <span class="n">lineno</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">linenostr</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">linenostr</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">lineno</span><span class="p">)</span>
            <span class="n">lineno</span> <span class="o">=</span> <span class="bp">None</span>

        <span class="k">if</span> <span class="n">islabel</span><span class="p">:</span>
            <span class="n">islabelstr</span> <span class="o">=</span> <span class="s">&#39;&gt;&gt;&#39;</span>
            <span class="n">islabel</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">islabelstr</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>

        <span class="k">if</span> <span class="n">op</span> <span class="ow">in</span> <span class="n">hasconst</span><span class="p">:</span>
            <span class="n">argstr</span> <span class="o">=</span> <span class="nb">repr</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">op</span> <span class="ow">in</span> <span class="n">hasjump</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">argstr</span> <span class="o">=</span> <span class="s">&#39;to &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">labeldict</span><span class="p">[</span><span class="n">arg</span><span class="p">])</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="n">argstr</span> <span class="o">=</span> <span class="nb">repr</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">op</span> <span class="ow">in</span> <span class="n">hasarg</span><span class="p">:</span>
            <span class="n">argstr</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">argstr</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>

        <span class="k">print</span> <span class="o">&gt;&gt;</span> <span class="n">to</span><span class="p">,</span> <span class="s">&#39;</span><span class="si">%3s</span><span class="s">     </span><span class="si">%2s</span><span class="s"> </span><span class="si">%4d</span><span class="s"> </span><span class="si">%-20s</span><span class="s"> </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="n">linenostr</span><span class="p">,</span>
            <span class="n">islabelstr</span><span class="p">,</span>
            <span class="n">i</span><span class="p">,</span>
            <span class="n">op</span><span class="p">,</span>
            <span class="n">argstr</span><span class="p">)</span>
</div>
<span class="k">def</span> <span class="nf">recompile</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Create a .pyc by disassembling the file and assembling it again, printing</span>
<span class="sd">    a message that the reassembled file was loaded.&quot;&quot;&quot;</span>
    <span class="c"># Most of the code here based on the compile.py module.</span>
    <span class="kn">import</span> <span class="nn">os</span>
    <span class="kn">import</span> <span class="nn">imp</span>
    <span class="kn">import</span> <span class="nn">marshal</span>
    <span class="kn">import</span> <span class="nn">struct</span>

    <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s">&#39;U&#39;</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">timestamp</span> <span class="o">=</span> <span class="nb">long</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">fstat</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">fileno</span><span class="p">())</span><span class="o">.</span><span class="n">st_mtime</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
        <span class="n">timestamp</span> <span class="o">=</span> <span class="nb">long</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">stat</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span><span class="o">.</span><span class="n">st_mtime</span><span class="p">)</span>
    <span class="n">codestring</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
    <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">codestring</span> <span class="ow">and</span> <span class="n">codestring</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">:</span>
        <span class="n">codestring</span> <span class="o">=</span> <span class="n">codestring</span> <span class="o">+</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">codeobject</span> <span class="o">=</span> <span class="nb">compile</span><span class="p">(</span><span class="n">codestring</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="s">&#39;exec&#39;</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">SyntaxError</span><span class="p">:</span>
        <span class="k">print</span> <span class="o">&gt;&gt;</span> <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;Skipping </span><span class="si">%s</span><span class="s"> - syntax error.&quot;</span> <span class="o">%</span> <span class="n">filename</span>
        <span class="k">return</span>
    <span class="n">cod</span> <span class="o">=</span> <span class="n">Code</span><span class="o">.</span><span class="n">from_code</span><span class="p">(</span><span class="n">codeobject</span><span class="p">)</span>
    <span class="n">message</span> <span class="o">=</span> <span class="s">&quot;reassembled </span><span class="si">%r</span><span class="s"> imported.</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">filename</span>
    <span class="n">cod</span><span class="o">.</span><span class="n">code</span><span class="p">[:</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span> <span class="c"># __import__(&#39;sys&#39;).stderr.write(message)</span>
        <span class="p">(</span><span class="n">LOAD_GLOBAL</span><span class="p">,</span> <span class="s">&#39;__import__&#39;</span><span class="p">),</span>
        <span class="p">(</span><span class="n">LOAD_CONST</span><span class="p">,</span> <span class="s">&#39;sys&#39;</span><span class="p">),</span>
        <span class="p">(</span><span class="n">CALL_FUNCTION</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
        <span class="p">(</span><span class="n">LOAD_ATTR</span><span class="p">,</span> <span class="s">&#39;stderr&#39;</span><span class="p">),</span>
        <span class="p">(</span><span class="n">LOAD_ATTR</span><span class="p">,</span> <span class="s">&#39;write&#39;</span><span class="p">),</span>
        <span class="p">(</span><span class="n">LOAD_CONST</span><span class="p">,</span> <span class="n">message</span><span class="p">),</span>
        <span class="p">(</span><span class="n">CALL_FUNCTION</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
        <span class="p">(</span><span class="n">POP_TOP</span><span class="p">,</span> <span class="bp">None</span><span class="p">),</span>
        <span class="p">]</span>
    <span class="n">codeobject2</span> <span class="o">=</span> <span class="n">cod</span><span class="o">.</span><span class="n">to_code</span><span class="p">()</span>
    <span class="n">fc</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="o">+</span><span class="s">&#39;c&#39;</span><span class="p">,</span> <span class="s">&#39;wb&#39;</span><span class="p">)</span>
    <span class="n">fc</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\0\0\0\0</span><span class="s">&#39;</span><span class="p">)</span>
    <span class="n">fc</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s">&#39;&lt;l&#39;</span><span class="p">,</span> <span class="n">timestamp</span><span class="p">))</span>
    <span class="n">marshal</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">codeobject2</span><span class="p">,</span> <span class="n">fc</span><span class="p">)</span>
    <span class="n">fc</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
    <span class="n">fc</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">fc</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">imp</span><span class="o">.</span><span class="n">get_magic</span><span class="p">())</span>
    <span class="n">fc</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">recompile_all</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;recursively recompile all .py files in the directory&quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">os</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">root</span><span class="p">,</span> <span class="n">dirs</span><span class="p">,</span> <span class="n">files</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">name</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s">&#39;.py&#39;</span><span class="p">):</span>
                    <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">name</span><span class="p">))</span>
                    <span class="k">print</span> <span class="o">&gt;&gt;</span> <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">,</span> <span class="n">filename</span>
                    <span class="n">recompile</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="n">recompile</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="kn">import</span> <span class="nn">os</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">2</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
        <span class="k">print</span> <span class="s">&quot;&quot;&quot;</span><span class="se">\</span>
<span class="s">Usage: </span><span class="si">%s</span><span class="s"> dir</span>

<span class="s">Search recursively for *.py in the given directory, disassemble and assemble</span>
<span class="s">them, adding a note when each file is imported.</span>

<span class="s">Use it to test byteplay like this:</span>
<span class="s">&gt; byteplay.py Lib</span>
<span class="s">&gt; make test</span>

<span class="s">Some FutureWarnings may be raised, but that&#39;s expected.</span>

<span class="s">Tip: before doing this, check to see which tests fail even without reassembling</span>
<span class="s">them...</span>
<span class="s">&quot;&quot;&quot;</span> <span class="o">%</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">recompile_all</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>
</pre></div>

          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../../enaml-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../../../index.html">enaml 0.2beta-1 documentation</a> &raquo;</li>
          <li><a href="../../index.html" >Module code</a> &raquo;</li>
  
    <li><a href="#">enaml.core.byteplay</a></li>
  

      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2012, Enthought, Inc..
      Last updated on May 23, 2012.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.1.2.
    </div>
  </body>
</html>