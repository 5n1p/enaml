<style>
	#editor_${column} {
	    position: relative;
	    width: 100%;
	    background-color: #fff;
	    height: 95%;
	}
</style>
<div class="container">
	<div class="tabs">
		<div data-sessionid="initial"></div>
	</div>
	<button class="add_button">+</button>
	<div id="editor_${column}"></div>
</div>

<script type="text/javascript">
	var Editor_${column} = new function(){
		var _this = this;
	    var EditSession = require('ace/edit_session').EditSession;
		this.editor = ace.edit("editor_${column}");
		this.tab_list = jQuery(jQuery('.tabs')[${column}]);
		this.tab_list.sortable({
			tolerance: 'pointer',
			helper: 'clone',
			scroll: false,
			distance: 15
		});

		this.sessions = {
			'initial' : new EditSession("")
		};

		this.tab_list.__defineSetter__("current_tab", function(tab) {
			jQuery(tab).addClass('current');
			this._current_tab = tab;
		});

		this.tab_list.__defineGetter__("current_tab", function() {
			return this._current_tab;
		});

		this.tab_list.__defineSetter__("old_tab", function(tab) {
			jQuery(tab).removeClass('current');
			this._old_tab = tab;
		});

		this.tab_list.__defineGetter__("old_tab", function() {
			return this._old_tab;
		});

		this.setTitle = function(title) {
			jQuery(jQuery('span', _this.tab_list.current_tab)[0]).text(title);
		}

		this.removeTabItem = function() {
			/* handler for when the 'x' on a tab is clicked

			*/
			li_list = jQuery('div', _this.tab_list);
			item = jQuery(this).parent();
			if (item.attr('data-sessionid') == 
				jQuery(_this.tab_list.current_tab).attr('data-sessionid')) {
				if (li_list.index(item) == li_list.length-1) {
					_this.tab_list.current_tab = item.prev();
				}
				else
					_this.tab_list.current_tab = item.next();

				if (_this.tab_list.current_tab.length == 0) {
					_this.tab_list.current_tab = null;
					_this.editor.setSession(new EditSession(""));
					jQuery(this).parent().remove();
					delete _this.sessions[item.attr('data-sessionid')];
					return
				}
			}
			s = _this.sessions[jQuery(_this.tab_list.current_tab).attr('data-sessionid')];
			_this.editor.setSession(s);

			jQuery(this).parent().remove();
			delete _this.sessions[item.attr('data-sessionid')];
		}

		this.generateId = function() {
			/* Generate a random 32 character id

			*/
			var result = '';
			for(var j=0; j<32; j++) {
				var i = Math.floor(Math.random()*16).toString(16).toUpperCase();
				result = result + i;
			}
			return result;
		}

		this.addTabItem = function(title) {
			/* Handler for when the '+' button is clicked

			*/
			if (typeof(title) !== String)
				title = 'Untitled';

			div_list = jQuery('div', _this.tab_list);
			div = document.createElement('div');
			div.innerHTML = title;
			var id = _this.generateId();
			jQuery(div).attr('data-sessionid', id);
			if (_this.tab_list.current_tab == null) {
				jQuery(div).addClass("current")
				_this.tab_list.current_tab = div
			}
			_this.tab_list.append(div);
			_this.setupTab(div);
			_this.sessions[id] = new EditSession('');
		}

		this.clickTabItem = function() {
			/* Handler for when a tab is clicked

			*/
			var id = jQuery(this).attr("data-sessionid");
			var session = _this.sessions[id];
			if (jQuery(this) != _this.tab_list.current_tab) {
				_this.editor.setSession(session);
				_this.tab_list.old_tab = _this.tab_list.current_tab;
				_this.tab_list.current_tab = jQuery(this);
			}
		}

		this.setupTab = function(tab) {
			/* Sets up a tab by wrapping the text in a span and
			adding the close button

			*/
			jQuery(tab).click(_this.clickTabItem);
			jQuery(tab).wrapInner("<span />");
			var button = document.createElement('button');
			button.innerHTML = "x";
			jQuery(button).click(_this.removeTabItem);
			jQuery(button).insertAfter(jQuery('span', tab)[0]);
		}

		this.tab_list.current_tab = jQuery('div', this.tab_list)[0];
		this.tab_list._old_tab = this.tab_list.current_tab;
 		jQuery(jQuery('.add_button')[${column}]).click(this.addTabItem)
		this.editor.setSession(this.sessions['initial']);

		var item_list = jQuery('div', this.tab_list);
		for (var i=0; i<item_list.length; i++) {
			this.setupTab(item_list[i]);
		}

		${events}
		${bindings}
	}();
</script>