<!--
   Copyright (c) 2012, Enthought, Inc.
   All rights reserved.
-->

<style>
	#editor_${column} {
	    position: relative;
	    width: 100%;
	    background-color: #fff;
	    top: 0.74em;
	}

	.container {
	    width: ${width}%;
	}
</style>

<div class="container">
	<div class="tabs"></div>
	<button class="add_button">+</button>
	<div id="editor_${column}"></div>
</div>

<script type="text/javascript">
	var editor_${column} = new function() {
		var _this = this;
	    var EditSession = require('ace/edit_session').EditSession;

		this.editor = ace.edit("editor_${column}");

		this.current_index = 0;
		this.tab_list = jQuery('.tabs').eq(${column});
		this.tab_list.sortable({
			tolerance: 'pointer',
			connectWith: '.tabs',
			scroll: false,
			distance: 15,
			placeholder: 'placeholder',
			helper: 'clone',
			opacity: 0.6,
			receive: function (event, ui) {
				_this.tab_list.old_tab = _this.tab_list.current_tab;
				_this.tab_list.current_tab = ui.item[0];
				ui.item.click(_this.clickTabItem);
				jQuery('button', ui.item).click(_this.removeTabItem);
				_this.refreshTabWidths();
			},
			remove: function(event, ui) {
				if (_this.tab_list.length == 0)
					_this.tab_list.current_tab = null;
				else {
					var tabs = jQuery('div', _this.tab_list);
					if (_this.current_index == 0)
						_this.tab_list.current_tab = tabs[_this.current_index];
					else 
						_this.tab_list.current_tab = tabs[_this.current_index-1];
				}
				ui.item.unbind('click');
				jQuery('button', ui.item).unbind('click');
				_this.refreshTabWidths();
			},
			start: function(event, ui) {
				_this.current_index = ui.item.index();
			},
			over: function(event, ui) {
				var tab_width = _this.refreshTabWidths();
				var padding = parseInt(jQuery(ui.item).css('padding-left'))*2;
				jQuery(ui.item).css('width', tab_width - padding - 4);
				jQuery(ui.helper).css('width', tab_width - padding - 4);
			},
			out: function(event, ui) {
				var tab_width = _this.refreshTabWidths();
				var padding = parseInt(jQuery(ui.item).css('padding-left'))*2;
				jQuery(ui.item).css('width', tab_width - padding - 4);
				jQuery(ui.helper).css('width', tab_width - padding - 4);
			}

		}).disableSelection();

		this.tab_list.__defineSetter__("current_tab", function(tab) {
			jQuery(tab).addClass('current');
			this._current_tab = tab;
			try {
				_this.editor.setSession(tab.session);
			}
			catch(e) {
				_this.editor.setSession(new EditSession(""));
			}
		});

		this.tab_list.__defineGetter__("current_tab", function() {
			return this._current_tab;
		});

		this.tab_list.__defineSetter__("old_tab", function(tab) {
			jQuery(tab).removeClass('current');
			this._old_tab = tab;
		});

		this.tab_list.__defineGetter__("old_tab", function() {
			return this._old_tab;
		});

		this.setTitle = function(index, title) {
			try {
				jQuery('span', _this.tab_list).eq(index).text(title);
			}
			catch(e) {
				_this.addTabItem({'title':title})
			}
		}

		this.setMode = function(index, mode) {
			try {
				jQuery('div', _this.tab_list)[index].session.setMode(mode);
			}
			catch(e) {
				_this.addTabItem({'mode':mode})
			}
		}

		this.setText = function(index, text) {
			try {
				jQuery('div', _this.tab_list)[index].session.getDocument().setValue(text);
			}
			catch(e) {
				_this.addTabItem({'text':text})
			}
		}

		this.setTabs = function(tabs) {
			if (tabs) {
				jQuery('.tabs').show();
				jQuery("div[id^='editor']").eq(${column}).height('95%');
			}
			else {
				jQuery('.tabs').hide();
				jQuery("div[id^='editor']").eq(${column}).height('99%');
			}
		}

		this.removeTabItem = function() {
			/* handler for when the 'x' on a tab is clicked

			*/
			var div_list = jQuery('div', _this.tab_list);
			var item = jQuery(this).parent();

			if (item[0].session == _this.editor.getSession()) {
				if (div_list.length == 1)
					_this.tab_list.current_tab == null;
				else if (div_list.index(item) == div_list.length-1)
					_this.tab_list.current_tab = item.prev()[0];
				else
					_this.tab_list.current_tab = item.next()[0];
			}
			item.remove();
			_this.refreshTabWidths();
		};

		this.addTabItem = function(info) {
			/* Add a tab item

			*/
			default_args = {
				'title': 'Untitled',
				'mode': 'text',
				'text': ''
			};
			options = jQuery.extend(default_args, info);

			div_list = jQuery('div', _this.tab_list);
			div = document.createElement('div');
			div.innerHTML = options['title'];
			div.session = new EditSession(options['text'], options['mode']);

			if (_this.tab_list.current_tab == null)
				_this.tab_list.current_tab = div
			_this.tab_list.append(div);
			_this.setupTab(div);

			div.session.doc.on('change', function(e) {
				py_ace_editor.set_text_from_js(${column}, 
					jQuery('div', _this.tab_list).index(_this.tab_list.current_tab),
					_this.tab_list.current_tab.session.getDocument().getValue());
			});

			_this.refreshTabWidths();
		};

		this.refreshTabWidths = function() {
			var div_list = jQuery('div', _this.tab_list)
			var container_width = jQuery('.tabs').width();
			var tab_width = container_width / div_list.length;
			jQuery.each(div_list, function(index, value) {
				var padding = parseInt(jQuery(value).css('padding-left'))*2;
				jQuery(value).css('width', tab_width - padding - 4);
			});
			return tab_width;
		}

		this.clickTabItem = function() {
			/* Handler for when a tab is clicked

			*/
			if (jQuery(this) != _this.tab_list.current_tab) {
				_this.tab_list.old_tab = _this.tab_list.current_tab;
				_this.tab_list.current_tab = this;
			}
		};

		this.setupTab = function(tab) {
			/* Sets up a tab by wrapping the text in a span and
			adding the close button

			*/
			jQuery(tab).click(_this.clickTabItem);
			jQuery(tab).wrapInner("<span>");
			var button = document.createElement('button');
			button.innerHTML = "x";
			jQuery(button).click(_this.removeTabItem);
			jQuery(button).insertAfter(jQuery('span', tab));
			jQuery(tab).hover(
				function() { jQuery(button).show(); },
				function() { jQuery(button).hide(); }
			);
			jQuery(button).hide();
		};

		this.tab_list.current_tab = jQuery('div', this.tab_list)[0];
		_this.refreshTabWidths();
 		jQuery('.add_button').eq(${column}).click(function() {
 			_this.addTabItem();
 			py_ace_editor.tab_added(${column}, _this.tab_list.length - 1);
	 	});

		${global_bindings}
	}();
</script>