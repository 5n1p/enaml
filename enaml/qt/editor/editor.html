<style>
	#editor_${column} {
	    position: relative;
	    width: 100%;
	    background-color: #fff;
	    height: 94%;
	}

	.container {
	    width: ${width}%;
	}
</style>

<div class="container">
	<div class="tabs"></div>
	<button class="add_button">+</button>
	<div id="editor_${column}"></div>
</div>

<script type="text/javascript">
	var editor_${column} = new function(){
		var _this = this;
	    var EditSession = require('ace/edit_session').EditSession;
		this.editor = ace.edit("editor_${column}");

		this.tab_list = jQuery(jQuery('.tabs')[${column}]);
		this.tab_list.sortable({
			tolerance: 'pointer',
			connectWith: '.tabs',
			scroll: false,
			distance: 15,
			receive: function (event, ui) {
				_this.tab_list.old_tab = _this.tab_list.current_tab;
				_this.tab_list.current_tab = ui.item[0];
				ui.item.click(_this.clickTabItem);
			},
			remove: function(event, ui) {
				_this.tab_list.current_tab = _this.tab_list.old_tab;
				_this.tab_list.old_tab = null;
				ui.item.unbind('click');
			}
		});

		this.tab_list.__defineSetter__("current_tab", function(tab) {
			jQuery(tab).addClass('current');
			this._current_tab = tab;
			try {
				_this.editor.setSession(tab.session);
			}
			catch(e) {
				_this.editor.setSession(new EditSession(""));
			}
		});

		this.tab_list.__defineGetter__("current_tab", function() {
			return this._current_tab;
		});

		this.tab_list.__defineSetter__("old_tab", function(tab) {
			jQuery(tab).removeClass('current');
			this._old_tab = tab;
		});

		this.tab_list.__defineGetter__("old_tab", function() {
			return this._old_tab;
		});

		this.setTitle = function(title) {
			jQuery(jQuery('span', _this.tab_list.current_tab)[0]).text(title);
		}

		this.removeTabItem = function() {
			/* handler for when the 'x' on a tab is clicked

			*/
			var div_list = jQuery('div', _this.tab_list);
			var item = jQuery(this).parent();

			if (div_list.length == 1) {
				item.remove();
				_this.tab_list.current_tab = null;
				_this.tab_list.old_tab = null;
				return;
			}

			if (div_list.index(item) == div_list.length-1) {
				_this.tab_list.current_tab = item.prev()[0];
			}
			else
				_this.tab_list.current_tab = item.next()[0];

			item.remove();
		}

		this.addTabItem = function(title) {
			/* Handler for when the '+' button is clicked

			*/
			if (typeof(title) !== String)
				title = 'Untitled';

			div_list = jQuery('div', _this.tab_list);
			div = document.createElement('div');
			div.innerHTML = title;
			div.session = new EditSession('');
			if (_this.tab_list.current_tab == null)
				_this.tab_list.current_tab = div
			_this.tab_list.append(div);
			_this.setupTab(div);
		}

		this.clickTabItem = function() {
			/* Handler for when a tab is clicked

			*/
			if (jQuery(this) != _this.tab_list.current_tab) {
				_this.tab_list.old_tab = _this.tab_list.current_tab;
				_this.tab_list.current_tab = this;
			}
		}

		this.setupTab = function(tab) {
			/* Sets up a tab by wrapping the text in a span and
			adding the close button

			*/
			jQuery(tab).click(_this.clickTabItem);
			jQuery(tab).wrapInner("<span />");
			var button = document.createElement('button');
			button.innerHTML = "x";
			jQuery(button).click(_this.removeTabItem);
			jQuery(button).insertAfter(jQuery('span', tab)[0]);
		}

		this.addTabItem('First Document');
		this.tab_list.current_tab = jQuery('div', this.tab_list)[0];
 		jQuery(jQuery('.add_button')[${column}]).click(this.addTabItem)

		var item_list = jQuery('div', this.tab_list);
		for (var i=0; i<item_list.length; i++) {
			this.setupTab(item_list[i]);
		}

		${events}
		${bindings}
	}();
</script>