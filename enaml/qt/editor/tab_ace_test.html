<html>
<head>
	<script src="${resource_path}/ace/ace.js" type="text/javascript"></script>
	<script src="${resource_path}/jquery-1.7.2.min.js" type="text/javascript"></script>
	<script src="${resource_path}/jquery-ui-1.8.21.custom.min.js" type="text/javascript"></script>
	<link rel="stylesheet" href="${resource_path}/editor.css" />
	<title>ACE</title>
</head>
<body>
	<div id="tabs">
		<ul id="tab_list">
			<li data-sessionid="0">Untitled</li>
		</ul>
		<button id="add_button">+</button>
	</div>
	<div id="editor"></div>

	<script type="text/javascript">
	    var EditSession = require('ace/edit_session').EditSession
		var editor = ace.edit("editor");
		var tab_list = jQuery('#tab_list');
		tab_list.sortable({
			//containment: 'parent',
			tolerance: 'pointer'
		});

		var sessions = {
			'0' : new EditSession('${text}', '${mode}')
		}

		tab_list.__defineSetter__("current_tab", function(tab) {
			jQuery(tab).css('background-color', '#000');
			jQuery(tab).css('color', '#fff');
			jQuery('button', tab).css('color', '#fff');
			this._current_tab = tab
		});

		tab_list.__defineSetter__("old_tab", function(tab) {
			jQuery(tab).css('background-color', 'gray');
			jQuery(tab).css('color', '#000');
			jQuery('button', tab).css('color', '#000');
		});

		var removeTabItem = function() {
			li_list = jQuery('li', tab_list);
			item = jQuery(this).parent();
			if (li_list.index(item) == li_list.length-1) {
				tab_list.current_tab = item.prev();
			}
			else
				tab_list.current_tab = item.next();

			s = sessions[jQuery(tab_list._current_tab).attr('data-sessionid')]
			editor.setSession(s);

			jQuery(this).parent().remove();
			delete sessions[item.attr('data-sessionid')];

			li_list = jQuery("li", tab_list);

			if (li_list.length == 1) {
				jQuery('button', li_list).hide();
				tab_list.sortable('disable');
			}
		}

		var addTabItem = function() {
			li_list = jQuery('li', tab_list);
			if (li_list.length == 1) {
				jQuery('button', li_list[0]).show();
			}
			li = document.createElement('li');
			li.innerHTML = 'Untitled'
			jQuery(li).attr('data-sessionid', '3');
			last_li = li_list[li_list.length-1]
			jQuery(li).insertAfter(last_li);
			setupTab(li);
			sessions['3'] = new EditSession('')
		}

		var clickTabItem = function() {
			var id = jQuery(this).attr("data-sessionid");
			var session = sessions[id];
			if (jQuery(this) != tab_list._current_tab) {
				editor.setSession(session);
				tab_list.old_tab = tab_list._current_tab
				tab_list.current_tab = jQuery(this);
			}
		}

		var setupTab = function(tab) {
			jQuery(tab).click(clickTabItem);
			var span = document.createElement('span');
			jQuery(tab).wrapInner(span);
			var button = document.createElement('button');
			button.innerHTML = "X";
			if (jQuery('li', tab_list).length == 1)
				jQuery(button).hide();
			jQuery(button).insertAfter(jQuery('span', tab)[0]);
			jQuery(button).click(removeTabItem);
		}

		var item_list  = jQuery('li', tab_list);
		for (var i=0; i<item_list.length; i++) {
			setupTab(item_list[i]);
		}

		tab_list.current_tab = jQuery('li', tab_list)[0];
		tab_list._old_tab = tab_list._current_tab
		jQuery('#add_button').click(addTabItem);

		editor.setSession(sessions[0]);

		${events}
		${bindings}

	</script>
</body>

</html>